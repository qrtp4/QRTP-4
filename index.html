<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>QRTP-4 Verifier</title>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tweetnacl@1.0.3/nacl-fast.min.js"></script>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family:system-ui,sans-serif; background:#0d1117; color:#c9d1d9; min-height:100vh; padding:20px; }
    .container { max-width:600px; margin:0 auto; }
    h1 { color:#58a6ff; margin-bottom:8px; text-align:center; }
    .subtitle { color:#8b949e; margin-bottom:32px; text-align:center; }
    
    .scene { position:relative; width:100%; max-width:520px; aspect-ratio:1/1; margin:0 auto; display:grid; place-items:center; border-radius:18px; background:radial-gradient(600px 300px at 50% 0%, rgba(80,150,255,0.12), transparent 60%); border:1px solid rgba(255,255,255,0.12); overflow:hidden; }
    
    #qr { width:min(92%, 420px); height:min(92%, 420px); image-rendering:pixelated; background:#fff; border-radius:14px; box-shadow:0 18px 55px rgba(0,0,0,0.45); }
    
    .overlay { position:absolute; width:min(92%, 420px); height:min(92%, 420px); pointer-events:none; }
    
    .live { position:absolute; width:76px; height:76px; border-radius:14px; border:1px solid rgba(90,170,255,0.75); background:rgba(0,0,0,0.55); color:#fff; display:flex; align-items:center; justify-content:center; font-weight:900; font-size:26px; letter-spacing:0.06em; box-shadow:0 0 0 1px rgba(255,255,255,0.08) inset, 0 0 22px rgba(70,150,255,0.12); text-shadow:0 1px 0 rgba(0,0,0,0.55); }
    .tl { top:22px; left:22px; }
    .tr { top:22px; right:22px; }
    .bl { bottom:22px; left:22px; }
    .br { bottom:22px; right:22px; }
    
    .center { position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); width:150px; height:150px; display:grid; place-items:center; }
    .seal { width:150px; height:150px; border-radius:999px; border:1px solid rgba(90,170,255,0.75); background:rgba(0,0,0,0.55); box-shadow:0 0 0 1px rgba(255,255,255,0.10) inset, 0 0 34px rgba(70,150,255,0.18); display:grid; place-items:center; animation:pulseSeal 2.6s ease-in-out infinite; }
    .glyph { font-size:48px; filter:drop-shadow(0 4px 14px rgba(0,0,0,0.5)); }
    .pulse { position:absolute; bottom:-18px; left:50%; transform:translateX(-50%); font-family:ui-monospace,monospace; font-size:12px; color:rgba(255,255,255,0.70); padding:6px 10px; border-radius:999px; border:1px solid rgba(255,255,255,0.10); background:rgba(0,0,0,0.35); white-space:nowrap; }
    
    @keyframes pulseSeal { 0%,100%{transform:scale(1)} 50%{transform:scale(1.035)} }
    
    .card { background:#161b22; border:1px solid #30363d; border-radius:12px; padding:20px; margin-top:24px; }
    label { display:block; margin-bottom:8px; color:#8b949e; font-size:14px; }
    textarea { width:100%; height:100px; background:#0d1117; border:1px solid #30363d; border-radius:8px; color:#c9d1d9; padding:12px; font-family:monospace; font-size:11px; resize:vertical; }
    .btn { padding:12px 20px; border:none; border-radius:8px; cursor:pointer; font-weight:600; margin-right:8px; margin-top:12px; }
    .btn-primary { background:#238636; color:#fff; }
    .btn-secondary { background:#21262d; color:#c9d1d9; border:1px solid #30363d; }
    .result { margin-top:16px; padding:16px; border-radius:8px; display:none; }
    .ok { background:#238636; color:#fff; }
    .fail { background:#da3633; color:#fff; }
    #status { font-family:monospace; font-size:12px; }
    .footer { margin-top:24px; text-align:center; color:#8b949e; font-size:12px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>QRTP-4 Verifier</h1>
    <p class="subtitle">Secure Passport Verifier Â· Cryptographic Identity Verification</p>
    
    <div class="scene">
      <canvas id="qr" width="360" height="360"></canvas>
      <div class="overlay">
        <div class="live tl" id="liveTL">--</div>
        <div class="live tr" id="liveTR">--</div>
        <div class="live bl" id="liveBL">--</div>
        <div class="live br" id="liveBR">--</div>
        <div class="center">
          <div class="seal">
            <span class="glyph" id="centerGlyph">ðŸ‘‘</span>
          </div>
          <div class="pulse" id="centerPulse">QRTP-4</div>
        </div>
      </div>
    </div>
    
    <div class="card">
      <label>QR Content (JSON envelope):</label>
      <textarea id="qr" placeholder='{"t":"QRTP4","v":"0.2","p":"...","s":"..."}'></textarea>
      <button class="btn btn-primary" id="verifyBtn">Verify</button>
      <button class="btn btn-secondary" id="loadBtn">Reload Registry</button>
      <div id="result" class="result"></div>
      <div id="status" style="margin-top:12px;"></div>
    </div>
    
    <div class="footer">QRTP-4 Protocol v0.2 | No Passport = No Trust</div>
  </div>
  
  <script>
    // QRTP-4 Symbol Pools - Multi-language support
    const QRTP4_POOLS = {
      core: 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789',
      symbols: 'â˜…â˜†â—â—¯â– â–¡â–³â–½â—†â—‡âŠ•âŠ—âˆ´âˆµ',
      geometry: 'â–²â–¼â—€â–¶â—¢â—£â—¤â—¥',
      arrows: 'â†’â†â†‘â†“â†”â†•â‡’â‡â‡‘â‡“',
      cyrillic: 'ÐÐ‘Ð’Ð“Ð”Ð•Ð–Ð—Ð˜Ð™ÐšÐ›ÐœÐÐžÐŸÐ Ð¡Ð¢Ð£Ð¤Ð¥Ð¦Ð§Ð¨Ð©ÐªÐ«Ð¬Ð­Ð®Ð¯',
      greek: 'Î‘Î’Î“Î”Î•Î–Î—Î˜Î™ÎšÎ›ÎœÎÎžÎŸÎ Î¡Î£Î¤Î¥Î¦Î§Î¨Î©',
      hebrew: '××‘×’×“×”×•×–×—×˜×™×›×œ×ž× ×¡×¢×¤×¦×§×¨×©×ª',
      arabic: 'Ø§Ø¨ØªØ«Ø¬Ø­Ø®Ø¯Ø°Ø±Ø²Ø³Ø´ØµØ¶Ø·Ø¸Ø¹ØºÙÙ‚ÙƒÙ„Ù…Ù†Ù‡ÙˆÙŠ',
      devanagari: 'à¤…à¤†à¤‡à¤ˆà¤‰à¤Šà¤‹à¤à¤à¤“à¤”à¤•à¤–à¤—à¤˜à¤™à¤šà¤›à¤œà¤à¤žà¤Ÿà¤ à¤¡à¤¢à¤£',
      thai: 'à¸à¸‚à¸ƒà¸„à¸…à¸†à¸‡à¸ˆà¸‰à¸Šà¸‹à¸Œà¸à¸Žà¸à¸à¸‘à¸’à¸“à¸”à¸•à¸–à¸—à¸˜à¸™à¸šà¸›à¸œà¸à¸žà¸Ÿà¸ à¸¡à¸¢à¸£à¸¥à¸§à¸¨à¸©à¸ªà¸«à¸¬à¸­à¸®',
      hangul: 'ã„±ã„´ã„·ã„¹ã…ã…‚ã……ã…‡ã…ˆã…Šã…‹ã…Œã…ã…Žã…ã…‘ã…“ã…•ã…—ã…›ã…œã… ã…¡ã…£',
      kana: 'ã‚ã„ã†ãˆãŠã‹ããã‘ã“ã•ã—ã™ã›ããŸã¡ã¤ã¦ã¨ãªã«ã¬ã­ã®',
      cjk: 'ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹åç™¾åƒä¸‡å„„å…†äº¬åž“',
      morse: 'Â·âˆ’Â·âˆ’Â·Â·âˆ’âˆ’Â·âˆ’âˆ’âˆ’âˆ’Â·Â·Â·Â·Â·âˆ’Â·Â·Â·Â·âˆ’âˆ’Â·Â·Â·âˆ’âˆ’âˆ’Â·âˆ’âˆ’âˆ’Â·Â·Â·Â·Â·'
    };
    
    const GLYPHS = ['ðŸ‘‘', 'ðŸ”', 'ðŸ›¡ï¸', 'ðŸ’Ž', 'âš¡', 'ðŸ”±', 'â™›', 'â™”'];
    const STEP_MS_CORNER = 500;
          chemistry: 'HHeLiBeBCNOFNeNaMgAlSiPSClArKCaScTiVCrMnFeCoNiCuZnGaGeAsSeBrKrRbSrYZrNbMoTcRuRhPdAgCdInSnSbTeIXeCsBaLaCePrNdPmSmEuGdTbDyHoErTmYbLuHfTaWReOsIrPtAuHgTlPbBiPoAtRnFrRaAcThPaUNpPuAmCmBkCfEsFmMdNoLrRfDbSgBhHsMtDsRgCnNhFlMcLvTsOg',
      physics: 'Ï€ÏÏƒÏ„Ï†ÏˆÏ‰Î±Î²Î³Î´ÎµÎ¶Î·Î¸ÎºÎ»Î¼Î½Î¾Ï…Ï‡Î”Î£Î¦Î¨Î©Ï€Â±âˆžâ‰ˆâ‰ â‰¤â‰¥âˆšâˆ«âˆ‚âˆ‡âˆ‘âˆâŠ•âŠ–âŠ—âŠ™âŸ¨âŸ©',
    const STEP_MS_CENTER = 800;
    
    // Get elements
    const $ = id => document.getElementById(id);
    const qrCanvas = $('qr');
    const liveTL = $('liveTL'), liveTR = $('liveTR'), liveBL = $('liveBL'), liveBR = $('liveBR');
    const centerGlyph = $('centerGlyph'), centerPulse = $('centerPulse');
    const qrInput = $('qrInput');
    const verifyBtn = $('verifyBtn'), loadBtn = $('loadBtn');
    const resultDiv = $('result'), statusDiv = $('status');
    
    // Render QR code
    async function renderQR(data) {
      const payload = typeof data === 'string' ? data : JSON.stringify(data);
      await QRCode.toCanvas(qrCanvas, payload, {
        errorCorrectionLevel: 'H',
        margin: 2,
        scale: 6,
        color: { dark: '#000000', light: '#ffffff' }
      });
    }
    
    // SHA-256 hash
    async function sha256(bytes) {
      const h = await crypto.subtle.digest('SHA-256', bytes);
      return new Uint8Array(h);
    }
    
    // UTF-8 encode
    function utf8Bytes(s) {
      return new TextEncoder().encode(s);
    }
    
    // Pick from pool deterministically
    function pickFromPool(hash, offset, pool) {
      return pool[hash[offset % hash.length] % pool.length];
    }
    
    // Generate deterministic corner token
    async function cornerToken(sigHash, timeStep, cornerId, mode = 'core') {
      const pool = QRTP4_POOLS[mode] || QRTP4_POOLS.core;
      const pre = new Uint8Array([...sigHash.slice(0, 16), ...utf8Bytes(timeStep + cornerId)]);
      const h = await sha256(pre);
      
      const c1 = pickFromPool(h, 0, pool);
      const c2 = pickFromPool(h, 1, pool);
      return c1 + c2;
    }
    
    // Generate center state
    async function centerState(sigHash, timeStep, mode = 'core') {
      const pool = QRTP4_POOLS[mode] || QRTP4_POOLS.core;
      const pre = new Uint8Array([...sigHash.slice(0, 16), ...utf8Bytes(timeStep + 'CENTER')]);
      const h = await sha256(pre);
      
      const glyph = GLYPHS[h[0] % GLYPHS.length];
      const tag = pickFromPool(h, 1, pool) + pickFromPool(h, 2, pool);
      return { glyph, tag };
    }
    
    // Live marker rotation
    let liveTimer = null;
    
    function stopLive() {
      if (liveTimer) {
        clearInterval(liveTimer);
        liveTimer = null;
      }
    }
    
    async function startLive(sigHash, mode = 'core') {
      stopLive();
      
      const tick = async () => {
        const tc = Math.floor(Date.now() / STEP_MS_CORNER);
        const tC = Math.floor(Date.now() / STEP_MS_CENTER);
        
        const [tl, tr, bl, br] = await Promise.all([
          cornerToken(sigHash, tc, 'TL', mode),
          cornerToken(sigHash, tc, 'TR', mode),
          cornerToken(sigHash, tc, 'BL', mode),
          cornerToken(sigHash, tc, 'BR', mode)
        ]);
        
        liveTL.textContent = tl;
        liveTR.textContent = tr;
        liveBL.textContent = bl;
        liveBR.textContent = br;
        
        const c = await centerState(sigHash, tC, mode);
        centerGlyph.textContent = c.glyph;
        centerPulse.textContent = `QRTP-4 ${c.tag}`;
      };
      
      await tick();
      liveTimer = setInterval(tick, 140);
    }
    
    // Initialize with demo QR
    (async () => {
      await renderQR({ protocol: 'QRTP-4', ts: Date.now() });
      const demoHash = await sha256(utf8Bytes('DEMO'));
      await startLive(demoHash);
    })();
    
    // Verify button (placeholder)
    verifyBtn.onclick = () => {
      statusDiv.textContent = 'âœ“ Verification system ready';
      resultDiv.style.display = 'block';
      resultDiv.className = 'result ok';
      resultDiv.textContent = 'QRTP-4 Verifier Active';
    };
    
    // Reload button
    loadBtn.onclick = async () => {
      statusDiv.textContent = 'âŸ³ Registry synced';
      await renderQR({ protocol: 'QRTP-4', ts: Date.now() });
    };
  </script>
</body>
</html>
